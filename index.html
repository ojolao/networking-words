<!DOCTYPE html>
<html>
  <head>
    <title>Networking Words </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type='application/javascript' src='vivagraph.min.js'> </script>
    <style type="text/css" media="screen">
        html, body, svg { width: 100%; height: 100%; position: absolute;}
    </style>
  </head>
  <body>
    <section class="user-input">
      <div>
        <form name="mainForm">
          Enter words to render in a network here:
          <input name="userWords" type="text"> <br>
          Select rendering mode:
          <input type="radio" name="renderingMode" value="SVG">SVG
          <input type="radio" name="renderingMode" value="webGL">WebGL <br>
          <input type="submit" value="submit">
        </form> 
      </div>
    </section>
    <div>
      <button>Reset</button>
    </div>
    <section>
      <div id="displayNetwork"></div>
    </section>
    <script> 
      const form = document.mainForm;

      const graph = Viva.Graph.graph();
      const graphics = Viva.Graph.View.svgGraphics();
      const renderer = Viva.Graph.View.renderer(graph, {
        container: document.getElementById('displayNetwork'),
        graphics: graphics,
      });

      graphics.node((node) => {
        const ui = Viva.Graph.svg('g');
        const svgText = Viva.Graph.svg('text').attr('y', '-4px').text(node.data.text);
        ui.append(svgText);
        return ui;
      }).placeNode((nodeUI, pos) => {
        nodeUI.attr('transform', 'translate(' + (pos.x - 16) + ',' + (pos.y - 16) + ')');
      });
      // renderer.run()

      function handleForm(event) {
        event.preventDefault();
        const words = document.mainForm.userWords.value;
        const rendMode = document.mainForm.renderingMode.value;
        parseConnection(words);
        renderer.run();
      }
      form.addEventListener('submit', handleForm);

      function parseConnection(words) {
        const wordCol = words.split(' ');
        const chars = {};
        wordCol.forEach((word, i) => {
          graph.addNode(word, { text: word, type: 'whole word' });
          const wordArray = word.split('');
          wordArray.forEach((char) => {
            if (!chars[char]) {
              chars[char] = { count: 1, count1: {} };
              graph.addNode(char, { text: char, type: 'letter' });
              chars[char].count1[word] = true;
              graph.addLink(char, word);
            } else {
                const addLetters = () => {
                  chars[char].count++;
                  const charCountStr = 'count' + chars[char].count;
                  const nodeId = char + charCountStr;
                  chars[char][charCountStr] = {};
                  chars[char][charCountStr][word] = true;
                  graph.addNode(nodeId, { text: char, type: 'letter' });
                  graph.addLink(nodeId, word);
                };
              if (i === 0) { // need to reevaluate since I'm repeating
                addLetters();
              } else {
                let start = 1;
                let inserted = false;
                while (start <= chars[char].count) {
                  const currentCount = 'count' + start;
                  if (!chars[char][currentCount][word]) {
                    chars[char][currentCount][word] = true;
                    inserted = true;
                    break;
                  } else {
                    start++;
                  }
                }
                if (!inserted) {
                  addLetters();
                }
              }
            }
          });
        });
        console.log('chars', chars);
      }
    </script>
  </body>
</html>